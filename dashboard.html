<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Tabbi Mate</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #F9FAFB;
            color: #1F2937;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            margin-bottom: 40px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
        }
        
        .logo-text .tabbi {
            color: #BF3143;
        }
        
        .logo-text .mate {
            color: #111827;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: #BF3143;
            color: white;
        }
        
        .btn-primary:hover {
            background: #D24152;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: white;
            color: #6B7280;
            border: 1px solid #E5E7EB;
        }
        
        .btn-secondary:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            align-items: start;
        }
        
        /* Cards */
        .card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 20px;
        }
        
        /* Profile Card */
        .profile-photo-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .profile-photo {
            position: relative;
            width: 120px;
            height: 120px;
            margin-bottom: 16px;
        }
        
        .profile-photo-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #F3F4F6;
            border: 2px solid #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }
        
        .profile-photo-circle:hover {
            border-color: #BF3143;
        }
        
        .profile-photo-circle svg {
            width: 48px;
            height: 48px;
            color: #9CA3AF;
        }
        
        .profile-photo-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-photo input[type="file"] {
            display: none;
        }
        
        .profile-upload-btn {
            font-size: 14px;
            color: #BF3143;
            cursor: pointer;
            font-weight: 500;
        }
        
        .profile-upload-btn:hover {
            color: #D24152;
            text-decoration: underline;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px;
            background: white;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            color: #1F2937;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s ease;
            min-height: 52px;
            box-sizing: border-box;
        }
        
        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #BF3143;
            box-shadow: 0 0 0 3px rgba(191, 49, 67, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-select {
            cursor: pointer;
        }
        
        .form-hint {
            font-size: 13px;
            color: #6B7280;
            margin-top: 6px;
        }

        .profile-action-bar {
            margin-top: 32px;
            padding-top: 20px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .profile-action-bar .btn {
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .profile-action-bar .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .profile-success-message {
            color: #059669;
            font-size: 14px;
            font-weight: 500;
            padding: 12px 16px;
            background: #D1FAE5;
            border-radius: 8px;
            margin-top: 12px;
            display: none;
        }

        .profile-error-message {
            color: #DC2626;
            font-size: 14px;
            font-weight: 500;
            padding: 12px 16px;
            background: #FEE2E2;
            border-radius: 8px;
            margin-top: 12px;
            display: none;
        }

        @media (max-width: 768px) {
            .profile-action-bar {
                flex-direction: column-reverse;
            }

            .profile-action-bar .btn {
                width: 100%;
            }
        }
        
        /* Language & Interests Summary */
        .language-summary,
        .interests-summary {
            margin: 20px 0;
            padding: 16px;
            background: #F3F4F6;
            border-radius: 12px;
            border: 1px solid #E5E7EB;
        }

        .language-summary-header,
        .interests-summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }

        .language-summary-header svg,
        .interests-summary-header svg {
            color: #BF3143;
        }

        #edit-languages-btn:hover,
        #edit-interests-btn:hover {
            background: #FEE2E2 !important;
        }

        .language-summary-list,
        .interests-summary-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .language-badge {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            transition: all 0.2s ease;
            min-height: 52px;
            box-sizing: border-box;
        }

        .language-badge:hover {
            border-color: #BF3143;
            box-shadow: 0 2px 8px rgba(191, 49, 67, 0.1);
        }

        .language-badge-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .language-badge-name {
            font-weight: 600;
            font-size: 14px;
            color: #111827;
        }

        .language-badge-level {
            font-size: 12px;
            color: #6B7280;
            padding: 2px 8px;
            background: #F3F4F6;
            border-radius: 4px;
        }

        .language-badge-delete {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9CA3AF;
            transition: color 0.2s ease;
            border-radius: 4px;
        }

        .language-badge-delete:hover {
            color: #EF4444;
            background: #FEE2E2;
        }

        .language-badge-level.native {
            color: #059669;
            font-weight: 600;
        }

        .language-badge-level.professional,
        .language-badge-level.advanced {
            color: #5B8DEF;
            font-weight: 600;
        }

        .language-badge-level.intermediate {
            color: #D97706;
            font-weight: 600;
        }

        .language-badge-level.basic {
            color: #6B7280;
        }

        .interest-badge {
            display: inline-flex;
            align-items: center;
            padding: 8px 14px;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 999px;
            font-size: 13px;
            color: #374151;
            font-weight: 500;
        }

        /* Interests */
        .interests-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            min-height: 32px;
        }
        
        .interest-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: rgba(191, 49, 67, 0.08);
            color: #374151;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .interest-pill:hover {
            background: rgba(191, 49, 67, 0.12);
        }
        
        .interest-pill button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            color: #9CA3AF;
            transition: color 0.2s ease;
        }
        
        .interest-pill button:hover {
            color: #BF3143;
        }
        
        .interest-pill button svg {
            width: 14px;
            height: 14px;
        }
        
        .interests-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .interests-input-wrapper .form-input {
            flex: 1;
            margin-bottom: 0;
        }
        
        .add-interest-btn {
            background: white;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .add-interest-btn:hover:not(:disabled) {
            background: #F9FAFB;
            border-color: #BF3143;
        }
        
        .add-interest-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .add-interest-btn svg {
            color: #6B7280;
        }
        
        .btn-save {
            width: 100%;
            margin-top: 24px;
            position: relative;
        }
        
        .btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-save.saved {
            background: #10B981;
        }
        
        /* Languages Card */
        .language-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            margin-bottom: 16px;
            align-items: center;
        }

        .language-row .btn-secondary {
            height: fit-content;
        }
        
        .language-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .language-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #F3F4F6;
            border: 1px solid #E5E7EB;
            border-radius: 20px;
            font-size: 14px;
            color: #374151;
        }
        
        .language-tag button {
            background: none;
            border: none;
            color: #6B7280;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            transition: color 0.2s ease;
        }
        
        .language-tag button:hover {
            color: #BF3143;
        }
        
        .add-language-btn {
            margin-top: 12px;
            padding: 8px 16px;
            background: white;
            border: 1px dashed #D1D5DB;
            border-radius: 8px;
            color: #6B7280;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }
        
        .add-language-btn:hover {
            background: #F9FAFB;
            border-color: #BF3143;
            color: #BF3143;
        }
        
        .match-preference {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #E5E7EB;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #BF3143;
            cursor: pointer;
        }
        
        .checkbox-group label {
            font-size: 15px;
            color: #374151;
            cursor: pointer;
        }
        
        /* Quick Actions Card */
        .action-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .action-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
        }
        
        .action-item:hover {
            background: white;
            border-color: #BF3143;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .action-icon {
            width: 40px;
            height: 40px;
            background: rgba(191, 49, 67, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .action-icon svg {
            width: 20px;
            height: 20px;
            color: #BF3143;
        }
        
        .action-content {
            flex: 1;
        }
        
        .action-title {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 2px;
        }
        
        .action-description {
            font-size: 13px;
            color: #6B7280;
        }
        
        /* Video Account Section */
        .video-status-section {
            margin-top: 16px;
        }
        
        .status-badge-container {
            margin-bottom: 12px;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .status-badge.status-disconnected {
            background: #FEE2E2;
            color: #DC2626;
        }
        
        .status-badge.status-connected {
            background: #D1FAE5;
            color: #059669;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-disconnected .status-dot {
            background: #DC2626;
        }
        
        .status-connected .status-dot {
            background: #059669;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .video-status-description {
            font-size: 14px;
            color: #6B7280;
            line-height: 1.5;
            margin-bottom: 16px;
        }
        
        .video-account-details {
            background: #F9FAFB;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #E5E7EB;
        }
        
        .hidden {
            display: none !important;
        }
        
        .video-account-details.hidden {
            display: none;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
        }
        
        .detail-label {
            color: #6B7280;
            font-weight: 500;
        }
        
        .detail-value {
            color: #111827;
        }
        
        .detail-value.video-status-active {
            color: #059669;
            font-weight: 600;
        }
        
        .video-action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Stats Card */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        
        .stat-item {
            text-align: center;
            padding: 16px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #BF3143;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 13px;
            color: #6B7280;
        }
        
        /* Favorites Card */
        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .favorite-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
        }
        
        .favorite-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(191, 49, 67, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            color: #BF3143;
            flex-shrink: 0;
        }
        
        .favorite-info {
            flex: 1;
        }
        
        .favorite-name {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 2px;
        }
        
        .favorite-languages {
            font-size: 13px;
            color: #6B7280;
        }
        
        .favorite-star-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: #D1D5DB;
            flex-shrink: 0;
        }
        
        .favorite-star-btn:hover {
            transform: scale(1.1);
        }
        
        .favorite-star-btn.active {
            color: #BF3143;
        }
        
        .favorite-star-btn svg {
            width: 24px;
            height: 24px;
        }
        
        /* Account Card */
        .account-info {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .info-row:last-of-type {
            border-bottom: none;
        }
        
        .info-label {
            font-size: 14px;
            color: #6B7280;
        }
        
        .info-value {
            font-size: 15px;
            color: #374151;
            font-weight: 500;
        }
        
        .plan-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(191, 49, 67, 0.1);
            color: #BF3143;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .signout-btn {
            margin-top: 16px;
            width: 100%;
            padding: 12px;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            color: #BF3143;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .signout-btn:hover {
            background: rgba(191, 49, 67, 0.05);
            border-color: #BF3143;
        }
        
        /* Sign Out Modal Button Styles */
        .signout-cancel-btn:hover {
            background: #E5E7EB !important;
        }
        
        .signout-confirm-btn:hover {
            background: #a52938 !important;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(191, 49, 67, 0.4) !important;
        }
        
        /* Crop Modal Button Styles */
        .crop-cancel-button:hover {
            background: #E5E7EB !important;
        }
        
        .crop-apply-button:hover {
            background: #a52938 !important;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(191, 49, 67, 0.4) !important;
        }
        
        /* Disconnect Video Modal Button Styles */
        .disconnect-cancel-btn:hover {
            background: #E5E7EB !important;
        }
        
        .disconnect-confirm-btn:hover {
            background: #a52938 !important;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(191, 49, 67, 0.4) !important;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 32px;
            color: #6B7280;
        }
        
        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        /* Responsive */
        @media (max-width: 968px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 640px) {
            body {
                padding: 16px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .header-actions {
                width: 100%;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }
            
            .card {
                padding: 20px;
            }
            
            .language-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Crop Modal Styles */
        .crop-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .crop-modal.hidden {
            display: none;
        }
        
        .crop-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .crop-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        
        .crop-close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }
        
        .crop-close-btn:hover {
            color: #1f2937;
        }
        
        .crop-container {
            padding: 20px;
            flex: 1;
            overflow: auto;
        }
        
        .crop-area {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            user-select: none;
        }
        
        #crop-image {
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        .crop-box {
            position: absolute;
            border: 2px solid #E63946;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            cursor: move;
        }
        
        .crop-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            border: 2px solid #E63946;
            border-radius: 50%;
        }
        
        .crop-handle.nw {
            top: -6px;
            left: -6px;
            cursor: nw-resize;
        }
        
        .crop-handle.ne {
            top: -6px;
            right: -6px;
            cursor: ne-resize;
        }
        
        .crop-handle.sw {
            bottom: -6px;
            left: -6px;
            cursor: sw-resize;
        }
        
        .crop-handle.se {
            bottom: -6px;
            right: -6px;
            cursor: se-resize;
        }
        
        .crop-actions {
            display: flex;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <a href="index.html" class="logo">
                <div class="logo-text">
                    <span class="tabbi">Tabbi</span><span class="mate"> Mate</span>
                </div>
            </a>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="window.handleStartCall()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 7l-7 5 7 5V7z"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                    </svg>
                    Start Video Chat
                </button>
                <button class="btn btn-secondary" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    Schedule (Coming soon)
                </button>
            </div>
        </header>
        
        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Left Column -->
            <div class="column-left">
                <!-- Profile Card -->
                <div class="card">
                    <h2 class="card-title">Profile</h2>
                    
                    <div class="profile-photo-wrapper">
                        <div class="profile-photo">
                            <label for="photo-upload" class="profile-photo-circle">
                                <svg id="default-avatar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                                <img id="profile-preview" style="display: none;" alt="Profile photo">
                            </label>
                            <input type="file" id="photo-upload" accept="image/*" aria-label="Upload profile photo">
                        </div>
                        <label for="photo-upload" class="profile-upload-btn">Upload photo</label>
                    </div>

                    <div class="form-group">
                        <label for="name" class="form-label">Display name</label>
                        <input type="text" id="name" class="form-input" placeholder="e.g., April K. or April" aria-label="Your display name">
                        <p class="form-hint">This is how other language mates will see you.</p>
                    </div>

                    <!-- Language Summary -->
                    <div id="language-summary" class="language-summary" style="display: none; position: relative;">
                        <button type="button" id="edit-languages-btn" onclick="scrollToLanguagesSection()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; color: #BF3143; font-size: 14px; font-weight: 600; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;">
                            Edit
                        </button>
                        <div class="language-summary-header">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                </svg>
                                <span>My Languages</span>
                            </div>
                        </div>
                        <div id="language-summary-list" class="language-summary-list">
                            <!-- Language badges will be dynamically added here -->
                        </div>

                        <!-- Add language button (only visible in edit mode) -->
                        <button type="button" id="add-language-summary-btn" class="add-language-btn" onclick="showAddLanguageForm()" style="display: none; margin-top: 16px;">+ Add a language</button>

                        <!-- Add language form (hidden by default) -->
                        <div id="add-language-inline-form" style="display: none; margin-top: 12px;">
                            <div class="language-row">
                                <select id="new-language-inline" class="form-select" aria-label="Select language">
                                    <option value="" disabled selected>Language</option>
                                    <option value="English">English</option>
                                    <option value="Spanish">Spanish</option>
                                    <option value="Korean">Korean</option>
                                </select>
                                <select id="new-level-inline" class="form-select" aria-label="Select level">
                                    <option value="" disabled selected>Level</option>
                                    <option value="Basic">Basic</option>
                                    <option value="Intermediate">Intermediate</option>
                                    <option value="Advanced">Advanced</option>
                                    <option value="Professional">Professional</option>
                                    <option value="Native">Native</option>
                                </select>
                                <button type="button" onclick="confirmAddLanguageInline()" style="padding: 8px 12px; background: none; border: none; cursor: pointer;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#BF3143" stroke-width="2">
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Interests Summary -->
                    <div id="interests-summary" class="interests-summary" style="display: none; position: relative;">
                        <button type="button" id="edit-interests-btn" onclick="scrollToInterestsSection()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; color: #BF3143; font-size: 14px; font-weight: 600; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;">
                            Edit
                        </button>
                        <div class="interests-summary-header">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                                <span>My Interests</span>
                            </div>
                        </div>
                        <div id="interests-summary-list" class="interests-summary-list">
                            <!-- Interest badges will be dynamically added here -->
                        </div>

                        <!-- Add interest button (only visible in edit mode) -->
                        <button type="button" id="add-interest-summary-btn" class="add-language-btn" onclick="showAddInterestForm()" style="display: none; margin-top: 16px;">+ Add an interest (max 3)</button>

                        <!-- Add interest form (hidden by default) -->
                        <div id="add-interest-inline-form" style="display: none; margin-top: 12px;">
                            <div class="interests-input-wrapper">
                                <input type="text" id="interest-input-inline" class="form-input" placeholder="Add an interest (max 3)" aria-label="Add interest" maxlength="30">
                                <button type="button" onclick="confirmAddInterestInline()" style="padding: 8px 12px; background: none; border: none; cursor: pointer;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#BF3143" stroke-width="2">
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" id="location" class="form-input" placeholder="e.g., San Francisco, CA" aria-label="Your location">
                    </div>

                    <div class="form-group">
                        <label for="bio" class="form-label">Bio</label>
                        <textarea id="bio" class="form-textarea" placeholder="Tell us a bit about yourself and your language learning goals..." aria-label="Your bio"></textarea>
                        <p class="form-hint">Tell others a little about you or your language goals.</p>
                    </div>

                    <!-- Success/Error Messages -->
                    <div id="profile-success-message" class="profile-success-message">Profile updated</div>
                    <div id="profile-error-message" class="profile-error-message">Could not save changes. Please try again.</div>

                    <!-- Action Bar -->
                    <div class="profile-action-bar">
                        <button type="button" class="btn btn-secondary" id="profile-cancel-btn">Cancel</button>
                        <button type="button" class="btn btn-primary" id="profile-save-btn" disabled>
                            <span id="profile-save-text">Save changes</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="column-right">
                <!-- Quick Actions Card -->
                <div class="card">
                    <h2 class="card-title">Quick Actions</h2>
                    <div class="action-list">
                        <a href="#" class="action-item" onclick="event.preventDefault(); window.handleStartCall();">
                            <div class="action-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M23 7l-7 5 7 5V7z"/>
                                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                                </svg>
                            </div>
                            <div class="action-content">
                                <div class="action-title">Start Practice Session</div>
                                <div class="action-description">Connect with a language partner now</div>
                            </div>
                        </a>
                        
                        <a href="#" class="action-item" onclick="event.preventDefault(); window.handleViewStudyNotes();">
                            <div class="action-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10 9 9 9 8 9"/>
                                </svg>
                            </div>
                            <div class="action-content">
                                <div class="action-title">View Study Notes</div>
                                <div class="action-description">Review your past sessions</div>
                            </div>
                        </a>
                    </div>
                </div>
                
                <!-- Video Account Card -->
                <div class="card">
                    <h2 class="card-title">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                            <path d="M23 7L16 12L23 17V7Z"/>
                            <rect x="1" y="5" width="15" height="14" rx="2"/>
                        </svg>
                        Video Account
                    </h2>
                    
                    <div class="video-status-section">
                        <div class="status-badge-container">
                            <div class="status-badge status-disconnected" id="video-status-badge">
                                <span class="status-dot"></span>
                                <span id="video-status-text">Not Connected</span>
                            </div>
                        </div>
                        
                        <p class="video-status-description" id="video-status-description">
                            Connect your video account to enable real-time video chat with language partners.
                        </p>
                        
                        <div class="video-account-details hidden" id="video-account-details">
                            <div class="detail-row">
                                <span class="detail-label">Email:</span>
                                <span class="detail-value" id="video-account-email">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="detail-value video-status-active">Active</span>
                            </div>
                        </div>
                        
                        <div class="video-action-buttons">
                            <button class="btn btn-primary" id="connect-video-account-btn" style="width: 100%;" onclick="window.handleConnectVideoAccount()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="8.5" cy="7" r="4"/>
                                    <polyline points="17 11 19 13 23 9"/>
                                </svg>
                                Connect Video Account
                            </button>
                            
                            <button class="btn btn-secondary hidden" id="disconnect-video-account-btn" onclick="window.handleDisconnectVideoAccount()" style="width: 100%; background: transparent; color: #DC2626; border: 1px solid #DC2626;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                                Disconnect
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Card -->
                <div class="card">
                    <h2 class="card-title">Your Stats</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="total-sessions">0</div>
                            <div class="stat-label">Sessions</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-minutes">0</div>
                            <div class="stat-label">Minutes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="day-streak">0</div>
                            <div class="stat-label">Day Streak</div>
                        </div>
                    </div>
                </div>
                
                <!-- Favorites Card -->
                <div class="card">
                    <h2 class="card-title">Favorite Partners</h2>
                    <div class="favorites-list" id="favorites-list">
                        <p style="color: #6B7280; text-align: center; padding: 20px;">
                            No favorite partners yet. Star your favorite partners after a practice session!
                        </p>
                    </div>
                </div>
                
                <!-- Account Card -->
                <div class="card">
                    <h2 class="card-title">Account</h2>
                    <div class="account-info">
                        <div class="info-row">
                            <span class="info-label">Email</span>
                            <span class="info-value" id="account-email">Loading...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Plan</span>
                            <span class="plan-badge">Free</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Member since</span>
                            <span class="info-value" id="member-since">Loading...</span>
                        </div>
                    </div>
                    <button class="signout-btn" onclick="window.handleSignOut()">Sign Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Map for Module Resolution -->
    <script type="importmap">
    {
      "imports": {
        "bridge": "https://proto2.makedo.com:8883/ux/scripts/bridge.js",
        "fetch": "https://proto2.makedo.com:8883/ux/scripts/fetch.js",
        "config": "https://proto2.makedo.com:8883/ux/scripts/configStatic.js"
      }
    }
    </script>

    <script type="module">
        // Import Fetch from fetch.js for Makedo login
        import Fetch from 'fetch';

        // Import and initialize Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCDa8BY71QImZ2_SpSklCitqU4dKFdoJzs",
            authDomain: "videotest-9435c.firebaseapp.com",
            projectId: "videotest-9435c",
            storageBucket: "videotest-9435c.firebasestorage.app",
            messagingSenderId: "698822546154",
            appId: "1:698822546154:web:e449341f3bee5e11333d93"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        console.log('ðŸ”¥ Firebase initialized');

        // Initialize dashboard
        let userId = null;
        let userEmail = null;
        let interests = [];
        let hasUnsavedChanges = false;
        
        // Get user ID from URL path
        function init() {
            // First, check URL parameter (from 404 redirect)
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('uid');
            
            if (urlUserId) {
                userId = urlUserId;
                localStorage.setItem('videotest_user_id', userId);
                
                // Clean up URL to remove query parameter
                const basePath = '/dashboard';
                const cleanUrl = `${basePath}/${userId}`;
                window.history.replaceState({}, '', cleanUrl);
            } else {
                // Check URL path for user ID (format: /dashboard/USER_ID)
                const pathParts = window.location.pathname.split('/');
                const lastPart = pathParts[pathParts.length - 1];
                
                // If last part looks like a user ID (not .html), use it
                if (lastPart && !lastPart.includes('.html') && lastPart !== 'dashboard') {
                    userId = lastPart;
                    localStorage.setItem('videotest_user_id', userId);
                    
                    // Clean up URL to remove the ID from the visible path
                    const basePath = window.location.pathname.includes('tabbimate') 
                        ? '/tabbimate/dashboard' 
                        : '/dashboard';
                    const cleanUrl = `${basePath}/${userId}`;
                    window.history.replaceState({}, '', cleanUrl);
                } else {
                    // Try to get from localStorage
                    userId = localStorage.getItem('videotest_user_id');
                }
            }
            
            // Get user email from localStorage
            userEmail = localStorage.getItem('videotest_user_email');
            
            // If no user ID, redirect to login
            if (!userId) {
                console.log('No user ID found, redirecting to auth page');
                window.location.href = 'auth.html';
                return;
            }
            
            console.log('Dashboard initialized for user:', userId);

            // Load user data first, then attempt auto-connect
            loadUserData().then(() => {
                // Auto-connect to Makedo video account if credentials match
                attemptAutoConnectMakedo();
            });

            // Load user statistics
            loadUserStats();

            // Setup auto-save
            setupAutoSave();
        }
        
        // Load user data from Firebase or localStorage
        async function loadUserData() {
            // Update email display if available
            if (userEmail) {
                const accountEmailEl = document.getElementById('account-email');
                if (accountEmailEl) {
                    accountEmailEl.textContent = userEmail;
                }
                
                // Update name from email (use part before @)
                const userName = userEmail.split('@')[0];
                const displayName = userName.charAt(0).toUpperCase() + userName.slice(1);
                
                // Update name in profile section if it's empty
                const nameInput = document.getElementById('name');
                if (nameInput && !nameInput.value) {
                    nameInput.value = displayName;
                }
            }
            
            // Get Firebase user to populate account creation date and email
            try {
                const { getAuth } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js');
                const auth = getAuth();
                const user = auth.currentUser;

                if (user) {
                    // Set user email for auto-connect
                    if (user.email && !userEmail) {
                        userEmail = user.email;
                        localStorage.setItem('videotest_user_email', userEmail);
                        console.log('User email set from Firebase Auth:', userEmail);
                    }

                    if (user.metadata && user.metadata.creationTime) {
                        const creationDate = new Date(user.metadata.creationTime);
                        const formattedDate = creationDate.toLocaleDateString('en-US', {
                            month: 'short',
                            year: 'numeric'
                        });
                        const memberSinceEl = document.getElementById('member-since');
                        if (memberSinceEl) {
                            memberSinceEl.textContent = formattedDate;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading user metadata:', error);
                const memberSinceEl = document.getElementById('member-since');
                if (memberSinceEl) {
                    // Use current date as fallback
                    const now = new Date();
                    const formattedDate = now.toLocaleDateString('en-US', {
                        month: 'short',
                        year: 'numeric'
                    });
                    memberSinceEl.textContent = formattedDate;
                }
            }
            
            // Load profile data from Firestore first, then fall back to localStorage
            try {
                const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js');
                const db = getFirestore();

                // Check profiles collection first
                const profileDocRef = doc(db, 'profiles', userId);
                const profileDoc = await getDoc(profileDocRef);

                let profile = null;

                if (profileDoc.exists()) {
                    // Load from Firestore profiles collection
                    console.log('âœ… Loading profile from Firestore (profiles)');
                    profile = profileDoc.data();
                    console.log('Profile data:', profile);

                    // Update member since from createdAt if available
                    if (profile.createdAt && profile.createdAt.toDate) {
                        const creationDate = profile.createdAt.toDate();
                        const formattedDate = creationDate.toLocaleDateString('en-US', {
                            month: 'short',
                            year: 'numeric'
                        });
                        const memberSinceEl = document.getElementById('member-since');
                        if (memberSinceEl) {
                            memberSinceEl.textContent = formattedDate;
                            console.log('Member since set from profile createdAt:', formattedDate);
                        }
                    } else {
                        // If profile doesn't have createdAt, check if member-since still says "Loading..."
                        const memberSinceEl = document.getElementById('member-since');
                        if (memberSinceEl && memberSinceEl.textContent === 'Loading...') {
                            // Use current date as last resort fallback
                            const now = new Date();
                            const formattedDate = now.toLocaleDateString('en-US', {
                                month: 'short',
                                year: 'numeric'
                            });
                            memberSinceEl.textContent = formattedDate;
                            console.log('Member since set to current date (fallback):', formattedDate);
                        }
                    }
                } else {
                    // Try legacy users collection
                    const userDocRef = doc(db, 'users', userId);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists()) {
                        console.log('âœ… Loading profile from Firestore (users - legacy)');
                        profile = userDoc.data();
                        console.log('Profile data:', profile);
                    } else {
                        // Fall back to localStorage
                        console.log('âŒ No Firestore data, checking localStorage');
                        const profileKey = `videotest_profile_${userId}`;
                        const savedProfile = localStorage.getItem(profileKey);
                        if (savedProfile) {
                            profile = JSON.parse(savedProfile);
                            console.log('Loaded from localStorage');
                        }
                    }
                }

                if (profile) {
                    console.log('ðŸ“ Applying profile data to form...');
                    // Update form fields with saved data
                    if (profile.name) {
                        const nameInput = document.getElementById('name');
                        if (nameInput) nameInput.value = profile.name;
                    }

                    if (profile.location) {
                        const locationInput = document.getElementById('location');
                        if (locationInput) locationInput.value = profile.location;
                    }

                    if (profile.bio) {
                        const bioTextarea = document.getElementById('bio');
                        if (bioTextarea) bioTextarea.value = profile.bio;
                    }

                    if (profile.photoUrl) {
                        const profilePreview = document.getElementById('profile-preview');
                        const defaultAvatar = document.getElementById('default-avatar');
                        if (profilePreview && defaultAvatar) {
                            profilePreview.src = profile.photoUrl;
                            profilePreview.style.display = 'block';
                            defaultAvatar.style.display = 'none';
                        }
                    }

                    if (profile.interests && Array.isArray(profile.interests)) {
                        interests = profile.interests;
                        renderInterests();
                    }

                    if (profile.languages && Array.isArray(profile.languages)) {
                        userLanguages = profile.languages;
                    } else {
                        // Default language for existing users
                        userLanguages = [{ language: 'English', level: 'Professional' }];
                    }
                    renderLanguages();
                    renderLanguageSummary();
                    renderInterestsSummary();
                } else {
                    // New user - start with empty language list
                    console.log('No profile data found');
                    userLanguages = [];
                    renderLanguages();
                    renderLanguageSummary();
                    renderInterestsSummary();
                }
            } catch (error) {
                console.error('Error loading profile data from Firestore:', error);
                // Fall back to localStorage on error
                const profileKey = `videotest_profile_${userId}`;
                const savedProfile = localStorage.getItem(profileKey);

                if (savedProfile) {
                    try {
                        const profile = JSON.parse(savedProfile);

                        if (profile.name) {
                            const nameInput = document.getElementById('name');
                            if (nameInput) nameInput.value = profile.name;
                        }

                        if (profile.location) {
                            const locationInput = document.getElementById('location');
                            if (locationInput) locationInput.value = profile.location;
                        }

                        if (profile.bio) {
                            const bioTextarea = document.getElementById('bio');
                            if (bioTextarea) bioTextarea.value = profile.bio;
                        }

                        if (profile.photoUrl) {
                            const profilePreview = document.getElementById('profile-preview');
                            const defaultAvatar = document.getElementById('default-avatar');
                            if (profilePreview && defaultAvatar) {
                                profilePreview.src = profile.photoUrl;
                                profilePreview.style.display = 'block';
                                defaultAvatar.style.display = 'none';
                            }
                        }

                        if (profile.interests && Array.isArray(profile.interests)) {
                            interests = profile.interests;
                            renderInterests();
                        }

                        if (profile.languages && Array.isArray(profile.languages)) {
                            userLanguages = profile.languages;
                        } else {
                            userLanguages = [{ language: 'English', level: 'Professional' }];
                        }
                        renderLanguages();
                        renderLanguageSummary();
                        renderInterestsSummary();
                    } catch (parseError) {
                        console.error('Error parsing localStorage profile:', parseError);
                        userLanguages = [];
                        renderLanguages();
                        renderLanguageSummary();
                        renderInterestsSummary();
                    }
                } else {
                    userLanguages = [];
                    renderLanguages();
                    renderLanguageSummary();
                    renderInterestsSummary();
                }
            }
            
            // Reset unsaved changes state
            hasUnsavedChanges = false;
            updateSaveButton();
        }
        
        // Load user statistics
        function loadUserStats() {
            const statsKey = `videotest_stats_${userId}`;
            const savedStats = localStorage.getItem(statsKey);
            
            let stats = {
                totalSessions: 0,
                totalMinutes: 0,
                dayStreak: 0,
                lastSessionDate: null,
                sessionDates: [] // Array of dates when user had sessions
            };
            
            if (savedStats) {
                try {
                    stats = JSON.parse(savedStats);
                    console.log('Loaded user stats:', stats);
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            } else {
                console.log('No previous stats found, starting from 0');
            }
            
            // Update the display
            document.getElementById('total-sessions').textContent = stats.totalSessions;
            document.getElementById('total-minutes').textContent = stats.totalMinutes;
            document.getElementById('day-streak').textContent = stats.dayStreak;
        }
        
        // Update user statistics after a session
        function updateUserStats(sessionMinutes) {
            const statsKey = `videotest_stats_${userId}`;
            const savedStats = localStorage.getItem(statsKey);
            
            let stats = {
                totalSessions: 0,
                totalMinutes: 0,
                dayStreak: 0,
                lastSessionDate: null,
                sessionDates: []
            };
            
            if (savedStats) {
                try {
                    stats = JSON.parse(savedStats);
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }
            
            // Update session count and minutes
            stats.totalSessions += 1;
            stats.totalMinutes += sessionMinutes;
            
            // Update day streak
            const today = new Date().toDateString();
            if (!stats.sessionDates.includes(today)) {
                stats.sessionDates.push(today);
            }
            
            // Calculate day streak
            if (stats.lastSessionDate) {
                const lastDate = new Date(stats.lastSessionDate);
                const currentDate = new Date();
                const diffTime = currentDate - lastDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    // Consecutive day
                    stats.dayStreak += 1;
                } else if (diffDays === 0) {
                    // Same day, don't increment
                } else {
                    // Streak broken, reset to 1
                    stats.dayStreak = 1;
                }
            } else {
                // First session ever
                stats.dayStreak = 1;
            }
            
            stats.lastSessionDate = today;
            
            // Save updated stats
            localStorage.setItem(statsKey, JSON.stringify(stats));
            
            // Update display
            document.getElementById('total-sessions').textContent = stats.totalSessions;
            document.getElementById('total-minutes').textContent = stats.totalMinutes;
            document.getElementById('day-streak').textContent = stats.dayStreak;
            
            console.log('Stats updated:', stats);
        }
        
        // Photo preview and crop functionality
        const photoUpload = document.getElementById('photo-upload');
        const profilePreview = document.getElementById('profile-preview');
        const defaultAvatar = document.getElementById('default-avatar');
        let currentImageFile = null;
        let cropState = {
            isDragging: false,
            isResizing: false,
            resizeHandle: null,
            startX: 0,
            startY: 0,
            cropBox: { x: 0, y: 0, width: 200, height: 200 }
        };
        
        photoUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                currentImageFile = file;
                const reader = new FileReader();
                reader.onload = function(event) {
                    // Show crop modal
                    showCropModal(event.target.result);
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Crop modal functions
        function showCropModal(imageSrc) {
            const cropModal = document.getElementById('crop-modal');
            const cropImage = document.getElementById('crop-image');
            const cropBox = document.getElementById('crop-box');
            
            cropImage.src = imageSrc;
            cropModal.classList.remove('hidden');
            
            // Initialize crop box after image loads
            cropImage.onload = function() {
                const imageRect = cropImage.getBoundingClientRect();
                const size = Math.min(imageRect.width, imageRect.height) * 0.7;
                const x = (imageRect.width - size) / 2;
                const y = (imageRect.height - size) / 2;
                
                cropState.cropBox = { x, y, width: size, height: size };
                updateCropBox();
                initializeCropInteractions();
            };
        }
        
        function closeCropModal() {
            const cropModal = document.getElementById('crop-modal');
            cropModal.classList.add('hidden');
            photoUpload.value = ''; // Reset file input
        }
        
        function updateCropBox() {
            const cropBox = document.getElementById('crop-box');
            cropBox.style.left = cropState.cropBox.x + 'px';
            cropBox.style.top = cropState.cropBox.y + 'px';
            cropBox.style.width = cropState.cropBox.width + 'px';
            cropBox.style.height = cropState.cropBox.height + 'px';
        }
        
        function initializeCropInteractions() {
            const cropBox = document.getElementById('crop-box');
            const cropImage = document.getElementById('crop-image');
            const handles = document.querySelectorAll('.crop-handle');
            
            // Drag crop box
            cropBox.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('crop-handle')) return;
                cropState.isDragging = true;
                cropState.startX = e.clientX - cropState.cropBox.x;
                cropState.startY = e.clientY - cropState.cropBox.y;
                e.preventDefault();
            });
            
            // Resize with handles
            handles.forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    cropState.isResizing = true;
                    cropState.resizeHandle = handle.classList[1]; // nw, ne, sw, se
                    cropState.startX = e.clientX;
                    cropState.startY = e.clientY;
                    e.stopPropagation();
                    e.preventDefault();
                });
            });
            
            // Mouse move handler
            document.addEventListener('mousemove', function(e) {
                const imageRect = cropImage.getBoundingClientRect();
                
                if (cropState.isDragging) {
                    let newX = e.clientX - cropState.startX;
                    let newY = e.clientY - cropState.startY;
                    
                    // Constrain to image bounds
                    newX = Math.max(0, Math.min(newX, imageRect.width - cropState.cropBox.width));
                    newY = Math.max(0, Math.min(newY, imageRect.height - cropState.cropBox.height));
                    
                    cropState.cropBox.x = newX;
                    cropState.cropBox.y = newY;
                    updateCropBox();
                }
                
                if (cropState.isResizing) {
                    const deltaX = e.clientX - cropState.startX;
                    const deltaY = e.clientY - cropState.startY;
                    const handle = cropState.resizeHandle;
                    
                    let newX = cropState.cropBox.x;
                    let newY = cropState.cropBox.y;
                    let newWidth = cropState.cropBox.width;
                    let newHeight = cropState.cropBox.height;
                    
                    // Calculate new dimensions based on handle
                    if (handle.includes('n')) {
                        newY += deltaY;
                        newHeight -= deltaY;
                    }
                    if (handle.includes('s')) {
                        newHeight += deltaY;
                    }
                    if (handle.includes('w')) {
                        newX += deltaX;
                        newWidth -= deltaX;
                    }
                    if (handle.includes('e')) {
                        newWidth += deltaX;
                    }
                    
                    // Enforce minimum size and bounds
                    const minSize = 50;
                    if (newWidth >= minSize && newHeight >= minSize &&
                        newX >= 0 && newY >= 0 &&
                        newX + newWidth <= imageRect.width &&
                        newY + newHeight <= imageRect.height) {
                        
                        cropState.cropBox = { x: newX, y: newY, width: newWidth, height: newHeight };
                        cropState.startX = e.clientX;
                        cropState.startY = e.clientY;
                        updateCropBox();
                    }
                }
            });
            
            // Mouse up handler
            document.addEventListener('mouseup', function() {
                cropState.isDragging = false;
                cropState.isResizing = false;
            });
        }
        
        function applyCrop() {
            console.log('=== Apply Crop clicked ===');
            
            const cropImage = document.getElementById('crop-image');
            if (!cropImage) {
                console.error('Crop image element not found');
                alert('Error: Could not find crop image');
                return;
            }
            
            console.log('Crop image found:', cropImage.src);
            console.log('Crop state:', cropState);
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Get the natural image dimensions
            const img = new Image();
            img.onload = function() {
                console.log('Image loaded, natural size:', img.naturalWidth, 'x', img.naturalHeight);
                
                const imageRect = cropImage.getBoundingClientRect();
                const scaleX = img.naturalWidth / imageRect.width;
                const scaleY = img.naturalHeight / imageRect.height;
                
                console.log('Scale factors:', scaleX, scaleY);
                
                // Calculate crop area in original image coordinates
                const cropX = cropState.cropBox.x * scaleX;
                const cropY = cropState.cropBox.y * scaleY;
                const cropWidth = cropState.cropBox.width * scaleX;
                const cropHeight = cropState.cropBox.height * scaleY;
                
                console.log('Crop area:', cropX, cropY, cropWidth, cropHeight);
                
                // Set canvas size to crop size
                canvas.width = cropWidth;
                canvas.height = cropHeight;
                
                // Draw cropped image
                ctx.drawImage(img, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
                
                // Convert to data URL and update profile preview
                const croppedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                console.log('Cropped image data URL length:', croppedDataUrl.length);
                
                const profilePreviewEl = document.getElementById('profile-preview');
                const defaultAvatarEl = document.getElementById('default-avatar');
                
                if (!profilePreviewEl) {
                    console.error('Profile preview element not found');
                    alert('Error: Could not find profile preview');
                    return;
                }
                
                profilePreviewEl.src = croppedDataUrl;
                profilePreviewEl.style.display = 'block';
                if (defaultAvatarEl) {
                    defaultAvatarEl.style.display = 'none';
                }
                
                console.log('Profile preview updated');
                
                // Close modal
                closeCropModal();
                console.log('Modal closed');
                
                // Mark as changed and save
                hasUnsavedChanges = true;
                updateSaveButton();
                saveProfileData();
                console.log('Profile data saved');
            };
            
            img.onerror = function() {
                console.error('Failed to load image for cropping');
                alert('Error: Failed to load image for cropping');
            };
            
            img.src = cropImage.src;
            console.log('Started loading image for crop');
        }
        
        // Languages Management
        let userLanguages = []; // Array of {language: "English", level: "Professional"}
        
        function renderLanguages() {
            const container = document.getElementById('languages-container');
            if (!container) return;
            
            if (userLanguages.length === 0) {
                container.innerHTML = '<p class="form-hint">Add at least one language to start matching</p>';
                return;
            }
            
            container.innerHTML = userLanguages.map((lang, index) => `
                <div class="language-row">
                    <select class="form-select" onchange="updateLanguage(${index}, this.value, null)" aria-label="Select language">
                        <option value="" disabled ${lang.language === '' ? 'selected' : ''}>Language</option>
                        <option value="English" ${lang.language === 'English' ? 'selected' : ''}>English</option>
                        <option value="Spanish" ${lang.language === 'Spanish' ? 'selected' : ''}>Spanish</option>
                        <option value="Korean" ${lang.language === 'Korean' ? 'selected' : ''}>Korean</option>
                    </select>
                    <select class="form-select" onchange="updateLanguage(${index}, null, this.value)" aria-label="Select level">
                        <option value="" disabled ${lang.level === '' ? 'selected' : ''}>Level</option>
                        <option value="Basic" ${lang.level === 'Basic' ? 'selected' : ''}>Basic</option>
                        <option value="Intermediate" ${lang.level === 'Intermediate' ? 'selected' : ''}>Intermediate</option>
                        <option value="Advanced" ${lang.level === 'Advanced' ? 'selected' : ''}>Advanced</option>
                        <option value="Professional" ${lang.level === 'Professional' ? 'selected' : ''}>Professional</option>
                        <option value="Native" ${lang.level === 'Native' ? 'selected' : ''}>Native</option>
                    </select>
                    <button type="button" class="btn btn-secondary" onclick="removeLanguage(${index})" style="padding: 8px 12px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }
        
        function addLanguageRow() {
            userLanguages.push({ language: '', level: '' });
            renderLanguages();
            renderLanguageSummary();
            hasUnsavedChanges = true;
            updateSaveButton();
        }

        function removeLanguage(index) {
            userLanguages.splice(index, 1);
            renderLanguages();
            renderLanguageSummary();
            hasUnsavedChanges = true;
            updateSaveButton();
        }
        
        function updateLanguage(index, language, level) {
            if (language !== null) {
                userLanguages[index].language = language;
            }
            if (level !== null) {
                userLanguages[index].level = level;
            }
            hasUnsavedChanges = true;
            updateSaveButton();
            renderLanguageSummary(); // Update summary when language changes
        }

        // Render language summary at top of profile
        function renderLanguageSummary() {
            const summaryContainer = document.getElementById('language-summary');
            const listContainer = document.getElementById('language-summary-list');
            const editBtn = document.getElementById('edit-languages-btn');
            const addLanguageBtn = document.getElementById('add-language-summary-btn');
            const addLanguageForm = document.getElementById('add-language-inline-form');

            if (!summaryContainer || !listContainer) return;

            // Always keep the container visible once shown
            summaryContainer.style.display = 'block';

            // If no languages, hide Edit button and show the inline form directly
            if (userLanguages.length === 0) {
                if (editBtn) editBtn.style.display = 'none';
                if (addLanguageBtn) addLanguageBtn.style.display = 'none';
                if (addLanguageForm) addLanguageForm.style.display = 'block';
                listContainer.innerHTML = '';
                return;
            }

            // If there are languages, show Edit button and hide form
            if (editBtn) editBtn.style.display = 'block';
            if (addLanguageForm) addLanguageForm.style.display = 'none';

            listContainer.innerHTML = userLanguages.map((lang, index) => {
                const levelClass = lang.level.toLowerCase();
                return `
                    <div class="language-badge">
                        <div class="language-badge-content">
                            <div class="language-badge-name">${lang.language}</div>
                            <div class="language-badge-level ${levelClass}">${lang.level}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle languages edit section when Edit button is clicked
        function scrollToLanguagesSection() {
            const editBtn = document.getElementById('edit-languages-btn');
            const addLanguageBtn = document.getElementById('add-language-summary-btn');

            if (editBtn) {
                const isEditMode = editBtn.textContent === 'Edit';

                if (isEditMode) {
                    // Enter edit mode
                    editBtn.textContent = 'Save';

                    // Show "+ Add a language" button
                    if (addLanguageBtn) addLanguageBtn.style.display = 'block';

                    // Add X buttons to language badges
                    renderLanguageSummaryWithDeleteButtons();
                } else {
                    // Exit edit mode - save changes
                    if (hasUnsavedChanges) {
                        saveProfileData();
                        hasUnsavedChanges = false;
                        updateSaveButton();
                    }

                    editBtn.textContent = 'Edit';

                    // Keep "+ Add a language" button visible if no languages, otherwise hide it
                    if (addLanguageBtn) {
                        addLanguageBtn.style.display = userLanguages.length === 0 ? 'block' : 'none';
                    }

                    // Always hide the add language form when exiting edit mode
                    const addLanguageForm = document.getElementById('add-language-inline-form');
                    if (addLanguageForm) {
                        addLanguageForm.style.display = 'none';
                    }

                    // Remove X buttons from language badges
                    renderLanguageSummary();
                }
            }
        }

        // Show the inline add language form
        function showAddLanguageForm() {
            const form = document.getElementById('add-language-inline-form');
            const btn = document.getElementById('add-language-summary-btn');

            if (form && btn) {
                form.style.display = 'block';
                btn.style.display = 'none';
            }
        }

        // Confirm adding a language from the inline form
        function confirmAddLanguageInline() {
            const languageSelect = document.getElementById('new-language-inline');
            const levelSelect = document.getElementById('new-level-inline');

            if (languageSelect.value && levelSelect.value) {
                const wasEmpty = userLanguages.length === 0;

                // Add the new language to the array
                userLanguages.push({
                    language: languageSelect.value,
                    level: levelSelect.value
                });

                // Reset selects
                languageSelect.value = '';
                levelSelect.value = '';

                // If this was the first language, show Edit button and enter edit mode
                if (wasEmpty) {
                    const editBtn = document.getElementById('edit-languages-btn');
                    if (editBtn) {
                        editBtn.style.display = 'block';
                        editBtn.textContent = 'Save';
                    }
                }

                // Re-render badges with X buttons (we're in edit mode)
                renderLanguageSummaryWithDeleteButtons();

                // Also update the main languages section
                renderLanguages();

                // Show the "+ Add a language" button after adding
                const btn = document.getElementById('add-language-summary-btn');
                if (btn) btn.style.display = 'block';

                // Hide the form
                const form = document.getElementById('add-language-inline-form');
                if (form) form.style.display = 'none';

                // Mark as unsaved
                hasUnsavedChanges = true;
                updateSaveButton();
            }
        }

        // Make functions globally accessible
        window.showAddLanguageForm = showAddLanguageForm;
        window.confirmAddLanguageInline = confirmAddLanguageInline;

        // Render language summary with delete buttons (edit mode)
        function renderLanguageSummaryWithDeleteButtons() {
            const listContainer = document.getElementById('language-summary-list');
            const editBtn = document.getElementById('edit-languages-btn');
            const addLanguageBtn = document.getElementById('add-language-summary-btn');
            const addLanguageForm = document.getElementById('add-language-inline-form');

            if (!listContainer) return;

            // If no languages in edit mode, hide Edit button and show inline form
            if (userLanguages.length === 0) {
                if (editBtn) editBtn.style.display = 'none';
                if (addLanguageBtn) addLanguageBtn.style.display = 'none';
                if (addLanguageForm) addLanguageForm.style.display = 'block';
                listContainer.innerHTML = '';
                return;
            }

            listContainer.innerHTML = userLanguages.map((lang, index) => {
                const levelClass = lang.level.toLowerCase();
                return `
                    <div class="language-badge" style="display: inline-flex; align-items: center; gap: 8px; padding-right: 8px;">
                        <div class="language-badge-content">
                            <div class="language-badge-name">${lang.language}</div>
                            <div class="language-badge-level ${levelClass}">${lang.level}</div>
                        </div>
                        <button type="button" onclick="removeLanguageFromSummary(${index})" style="background: none; border: none; cursor: pointer; display: flex; align-items: center; padding: 0; color: #6B7280; transition: color 0.2s;" onmouseover="this.style.color='#BF3143'" onmouseout="this.style.color='#6B7280'">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Remove language from summary (called from badge X button)
        function removeLanguageFromSummary(index) {
            removeLanguage(index);
            renderLanguageSummaryWithDeleteButtons();
        }

        // Make function globally accessible
        window.removeLanguageFromSummary = removeLanguageFromSummary;

        // Toggle interests section when Edit button is clicked
        function scrollToInterestsSection() {
            const interestsSection = document.getElementById('interests-input');
            const editBtn = document.getElementById('edit-interests-btn');
            const addInterestBtn = document.getElementById('add-interest-summary-btn');

            if (editBtn) {
                const isEditMode = editBtn.textContent === 'Edit';

                if (isEditMode) {
                    // Enter edit mode
                    editBtn.textContent = 'Save';

                    // Show X buttons on interest badges
                    renderInterestsSummaryWithDeleteButtons();

                    // Show "+ Add an interest" button (if not at max)
                    if (addInterestBtn && interests.length < 3) {
                        addInterestBtn.style.display = 'block';
                    }

                    // Show the interests input section
                    if (interestsSection) {
                        const parentFormGroup = interestsSection.closest('.form-group');
                        if (parentFormGroup) {
                            parentFormGroup.style.display = 'block';
                        }
                    }
                } else {
                    // Exit edit mode - save changes
                    if (hasUnsavedChanges) {
                        saveProfileData();
                        hasUnsavedChanges = false;
                        updateSaveButton();
                    }

                    editBtn.textContent = 'Edit';

                    // Hide "+ Add an interest" button and form
                    if (addInterestBtn) {
                        addInterestBtn.style.display = 'none';
                    }
                    const addInterestForm = document.getElementById('add-interest-inline-form');
                    if (addInterestForm) {
                        addInterestForm.style.display = 'none';
                    }

                    // Remove X buttons from interest badges
                    renderInterestsSummary();

                    // Hide the interests input section
                    if (interestsSection) {
                        const parentFormGroup = interestsSection.closest('.form-group');
                        if (parentFormGroup) {
                            parentFormGroup.style.display = 'none';
                        }
                    }
                }
            }
        }

        // Make functions globally accessible
        window.scrollToLanguagesSection = scrollToLanguagesSection;
        window.scrollToInterestsSection = scrollToInterestsSection;

        // Render interests summary at top of profile
        function renderInterestsSummary() {
            const summaryContainer = document.getElementById('interests-summary');
            const listContainer = document.getElementById('interests-summary-list');
            const editBtn = document.getElementById('edit-interests-btn');

            if (!summaryContainer || !listContainer) return;

            // Always keep the container visible once shown
            summaryContainer.style.display = 'block';

            // If no interests, hide Edit button
            if (interests.length === 0) {
                if (editBtn) editBtn.style.display = 'none';
                listContainer.innerHTML = '';
                return;
            }

            // If there are interests, show Edit button
            if (editBtn) editBtn.style.display = 'block';

            listContainer.innerHTML = interests.map(interest => {
                return `<div class="interest-badge">${interest}</div>`;
            }).join('');
        }

        // Render interests summary with delete buttons (edit mode)
        function renderInterestsSummaryWithDeleteButtons() {
            const listContainer = document.getElementById('interests-summary-list');
            const editBtn = document.getElementById('edit-interests-btn');

            if (!listContainer) return;

            // If no interests in edit mode, hide Edit button
            if (interests.length === 0) {
                if (editBtn) editBtn.style.display = 'none';
                listContainer.innerHTML = '';
                return;
            }

            listContainer.innerHTML = interests.map((interest, index) => {
                return `
                    <div class="interest-badge" style="display: inline-flex; align-items: center; gap: 8px; padding-right: 8px;">
                        <span>${interest}</span>
                        <button type="button" onclick="removeInterestFromSummary(${index})" style="background: none; border: none; cursor: pointer; display: flex; align-items: center; padding: 0; color: #6B7280; transition: color 0.2s;" onmouseover="this.style.color='#BF3143'" onmouseout="this.style.color='#6B7280'">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Remove interest from summary (called from badge X button)
        function removeInterestFromSummary(index) {
            interests.splice(index, 1);
            renderInterestsSummaryWithDeleteButtons();

            // Show "+ Add an interest" button if under max (3)
            const addInterestBtn = document.getElementById('add-interest-summary-btn');
            if (addInterestBtn && interests.length < 3) {
                addInterestBtn.style.display = 'block';
            }

            hasUnsavedChanges = true;
            updateSaveButton();
        }

        // Make function globally accessible
        window.removeInterestFromSummary = removeInterestFromSummary;

        // Show the inline add interest form
        function showAddInterestForm() {
            const form = document.getElementById('add-interest-inline-form');
            const btn = document.getElementById('add-interest-summary-btn');

            if (form && btn) {
                form.style.display = 'block';
                btn.style.display = 'none';
            }
        }

        // Confirm adding an interest from the inline form
        function confirmAddInterestInline() {
            const interestInput = document.getElementById('interest-input-inline');

            if (interestInput.value.trim() && interests.length < 3) {
                interests.push(interestInput.value.trim());

                // Reset input
                interestInput.value = '';

                // Re-render badges with X buttons
                renderInterestsSummaryWithDeleteButtons();

                // Hide form and show button again (if not at max)
                const form = document.getElementById('add-interest-inline-form');
                const btn = document.getElementById('add-interest-summary-btn');
                if (form && btn) {
                    form.style.display = 'none';
                    if (interests.length < 3) {
                        btn.style.display = 'block';
                    } else {
                        btn.style.display = 'none';
                    }
                }

                // Mark as unsaved
                hasUnsavedChanges = true;
                updateSaveButton();
            }
        }

        // Make functions globally accessible
        window.showAddInterestForm = showAddInterestForm;
        window.confirmAddInterestInline = confirmAddInterestInline;

        // Auto-save profile data when inputs change
        // Store original values for cancel functionality
        let originalProfileData = {
            name: '',
            location: '',
            bio: ''
        };

        function setupAutoSave() {
            const nameInput = document.getElementById('name');
            const locationInput = document.getElementById('location');
            const bioTextarea = document.getElementById('bio');
            const saveBtn = document.getElementById('profile-save-btn');
            const cancelBtn = document.getElementById('profile-cancel-btn');

            // Store original values
            originalProfileData = {
                name: nameInput ? nameInput.value : '',
                location: locationInput ? locationInput.value : '',
                bio: bioTextarea ? bioTextarea.value : ''
            };

            // Mark as changed when any field is edited
            function markAsChanged() {
                hasUnsavedChanges = true;
                if (saveBtn) saveBtn.disabled = false;
            }

            if (nameInput) {
                nameInput.addEventListener('input', markAsChanged);
            }
            if (locationInput) {
                locationInput.addEventListener('input', markAsChanged);
            }
            if (bioTextarea) {
                bioTextarea.addEventListener('input', markAsChanged);
            }

            // Setup save button
            if (saveBtn) {
                saveBtn.addEventListener('click', handleProfileSave);
            }

            // Setup cancel button
            if (cancelBtn) {
                cancelBtn.addEventListener('click', handleProfileCancel);
            }

            // Setup interests functionality
            setupInterests();
        }

        // Handle profile save
        async function handleProfileSave() {
            const saveBtn = document.getElementById('profile-save-btn');
            const saveText = document.getElementById('profile-save-text');
            const successMsg = document.getElementById('profile-success-message');
            const errorMsg = document.getElementById('profile-error-message');

            if (!saveBtn || !saveText) return;

            // Show loading state
            saveBtn.disabled = true;
            saveText.textContent = 'Savingâ€¦';
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            try {
                // Call existing save function
                await saveProfileData();

                // Update original values
                const nameInput = document.getElementById('name');
                const locationInput = document.getElementById('location');
                const bioTextarea = document.getElementById('bio');
                originalProfileData = {
                    name: nameInput ? nameInput.value : '',
                    location: locationInput ? locationInput.value : '',
                    bio: bioTextarea ? bioTextarea.value : ''
                };

                // Show success message
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);

                hasUnsavedChanges = false;
            } catch (error) {
                console.error('Error saving profile:', error);
                errorMsg.style.display = 'block';
                setTimeout(() => {
                    errorMsg.style.display = 'none';
                }, 5000);
                saveBtn.disabled = false;
            }

            // Reset button text
            saveText.textContent = 'Save changes';
        }

        // Handle profile cancel
        function handleProfileCancel() {
            const nameInput = document.getElementById('name');
            const locationInput = document.getElementById('location');
            const bioTextarea = document.getElementById('bio');
            const saveBtn = document.getElementById('profile-save-btn');
            const successMsg = document.getElementById('profile-success-message');
            const errorMsg = document.getElementById('profile-error-message');

            // Revert to original values
            if (nameInput) nameInput.value = originalProfileData.name;
            if (locationInput) locationInput.value = originalProfileData.location;
            if (bioTextarea) bioTextarea.value = originalProfileData.bio;

            // Reset state
            hasUnsavedChanges = false;
            if (saveBtn) saveBtn.disabled = true;
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
        }
        
        // Setup interests add/remove
        function setupInterests() {
            const interestsInput = document.getElementById('interests-input');
            const addBtn = document.getElementById('add-interest-btn');
            
            if (interestsInput) {
                // Add on Enter key
                interestsInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addInterest();
                    }
                });
            }
            
            if (addBtn) {
                addBtn.addEventListener('click', addInterest);
            }
            
            updateInterestsUI();
        }
        
        // Add new interest
        function addInterest() {
            const input = document.getElementById('interests-input');
            const value = input.value.trim();

            if (!value) return;

            if (interests.length >= 3) {
                return; // Already at max
            }

            if (!interests.includes(value)) {
                interests.push(value);
                renderInterests();
                renderInterestsSummary();
                hasUnsavedChanges = true;
                updateSaveButton();
            }

            input.value = '';
            updateInterestsUI();
        }

        // Remove interest
        function removeInterest(index) {
            interests.splice(index, 1);
            renderInterests();
            renderInterestsSummary();
            hasUnsavedChanges = true;
            updateSaveButton();
            updateInterestsUI();
        }
        
        // Render interests pills
        function renderInterests() {
            const container = document.getElementById('interests-pills');
            if (!container) return;
            
            container.innerHTML = interests.map((interest, index) => `
                <div class="interest-pill">
                    ${interest}
                    <button type="button" onclick="removeInterest(${index})" aria-label="Remove ${interest}">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }
        
        // Update interests UI state
        function updateInterestsUI() {
            const input = document.getElementById('interests-input');
            const addBtn = document.getElementById('add-interest-btn');
            const hint = document.getElementById('interests-hint');
            
            const atMax = interests.length >= 3;
            
            if (input) {
                input.disabled = atMax;
                input.placeholder = atMax ? 'Maximum 3 interests' : 'Add an interest (max 3)';
            }
            
            if (addBtn) {
                addBtn.disabled = atMax;
            }
            
            if (hint) {
                if (atMax) {
                    hint.textContent = 'Maximum 3 interests';
                    hint.style.color = '#6B7280';
                } else {
                    hint.textContent = '';
                }
            }
        }
        
        // Update save button state
        function updateSaveButton() {
            const saveProfileBtn = document.getElementById('save-profile-btn');
            const saveLanguagesBtn = document.getElementById('save-languages-btn');

            if (saveProfileBtn) {
                saveProfileBtn.disabled = !hasUnsavedChanges;
            }
            if (saveLanguagesBtn) {
                saveLanguagesBtn.disabled = !hasUnsavedChanges;
            }
        }
        
        // Handle save profile
        function handleSaveProfile(buttonId = 'save-profile-btn') {
            const saveBtn = document.getElementById(buttonId);
            if (!saveBtn || !hasUnsavedChanges) return;

            // Validate interests count
            if (interests.length > 3) {
                alert('You can only have up to 3 interests.');
                return;
            }

            // Save to localStorage
            saveProfileData();

            // Show success state on both buttons
            hasUnsavedChanges = false;
            const saveProfileBtn = document.getElementById('save-profile-btn');
            const saveLanguagesBtn = document.getElementById('save-languages-btn');

            [saveProfileBtn, saveLanguagesBtn].forEach(btn => {
                if (btn) {
                    btn.classList.add('saved');
                    btn.textContent = 'Saved âœ“';
                    btn.disabled = true;
                }
            });

            // Revert after 2 seconds
            setTimeout(() => {
                [saveProfileBtn, saveLanguagesBtn].forEach(btn => {
                    if (btn) {
                        btn.classList.remove('saved');
                        btn.textContent = 'Save Changes';
                    }
                });
            }, 2000);
        }
        
        // Save profile data to localStorage
        function saveProfileData() {
            if (!userId) return;
            
            const profileKey = `videotest_profile_${userId}`;
            const profile = {
                name: document.getElementById('name')?.value || '',
                location: document.getElementById('location')?.value || '',
                bio: document.getElementById('bio')?.value || '',
                photoUrl: document.getElementById('profile-preview')?.src || null,
                interests: interests,
                languages: userLanguages
            };
            
            localStorage.setItem(profileKey, JSON.stringify(profile));
            console.log('Profile data saved for user:', userId);
        }
        
        // Sign out handler
        function handleSignOut() {
            // Show custom sign-out modal
            const modal = document.getElementById('signout-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }
        
        // Setup no study notes modal event listeners
        function setupNoNotesModal() {
            const modal = document.getElementById('no-notes-modal');
            const closeBtn = document.getElementById('no-notes-close');
            const startSessionBtn = document.getElementById('no-notes-start-session');

            // Close button - close modal
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    if (modal) modal.classList.add('hidden');
                });
            }

            // Start session button - close modal and start a session
            if (startSessionBtn) {
                startSessionBtn.addEventListener('click', () => {
                    if (modal) modal.classList.add('hidden');
                    // Start a practice session
                    window.handleStartCall();
                });
            }

            // Close modal when clicking outside
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            }
        }

        // Setup sign-out modal event listeners
        function setupSignOutModal() {
            const modal = document.getElementById('signout-modal');
            const cancelBtn = document.getElementById('signout-cancel');
            const confirmBtn = document.getElementById('signout-confirm');
            
            // Cancel button - close modal
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    if (modal) modal.classList.add('hidden');
                });
            }
            
            // Confirm button - sign out
            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    // Clear any stored data
                    localStorage.clear();
                    // Redirect to home page
                    window.location.href = 'index.html';
                });
            }
            
            // Close modal when clicking outside
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            }
        }

        // Setup profile incomplete modal event listeners
        function setupProfileIncompleteModal() {
            const modal = document.getElementById('profile-incomplete-modal');
            const okBtn = document.getElementById('profile-incomplete-ok');

            // OK button - close modal
            if (okBtn) {
                okBtn.addEventListener('click', () => {
                    if (modal) modal.classList.add('hidden');
                });
            }

            // Close modal when clicking outside
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            }
        }

        // Show profile incomplete modal with custom message
        function showProfileIncompleteModal(message) {
            const modal = document.getElementById('profile-incomplete-modal');
            const messageElement = document.getElementById('profile-incomplete-message');

            if (messageElement && message) {
                messageElement.textContent = message;
            }

            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        // Setup crop modal event listeners
        function setupCropModal() {
            const modal = document.getElementById('crop-modal');
            const closeXBtn = document.getElementById('crop-close-x-btn');
            const cancelBtn = document.getElementById('crop-cancel-btn');
            const applyBtn = document.getElementById('crop-apply-btn');
            
            console.log('Setting up crop modal listeners');
            console.log('Close X button:', closeXBtn);
            console.log('Cancel button:', cancelBtn);
            console.log('Apply button:', applyBtn);
            
            // Close X button
            if (closeXBtn) {
                closeXBtn.addEventListener('click', () => {
                    console.log('Close X clicked');
                    closeCropModal();
                });
            }
            
            // Cancel button
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    console.log('Cancel clicked');
                    closeCropModal();
                });
            }
            
            // Apply button
            if (applyBtn) {
                applyBtn.addEventListener('click', () => {
                    console.log('Apply Crop clicked');
                    applyCrop();
                });
            }
            
            // Close modal when clicking outside
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        console.log('Clicked outside modal');
                        closeCropModal();
                    }
                });
            }
        }
        
        // Setup disconnect video modal event listeners
        function setupDisconnectVideoModal() {
            const modal = document.getElementById('disconnect-video-modal');
            const cancelBtn = document.getElementById('disconnect-cancel');
            const confirmBtn = document.getElementById('disconnect-confirm');
            
            // Cancel button - close modal
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    if (modal) modal.classList.add('hidden');
                });
            }
            
            // Confirm button - disconnect
            if (confirmBtn) {
                console.log('Disconnect confirm button found, attaching listener');
                confirmBtn.addEventListener('click', () => {
                    console.log('=== DISCONNECT CONFIRM BUTTON CLICKED ===');
                    console.log('Current makedoState:', makedoState);

                    // Clear Makedo login state
                    makedoState.isLoggedIn = false;
                    makedoState.userEmail = null;
                    makedoState.userId = null;

                    // Clear the new localStorage key
                    localStorage.removeItem('videotest_makedo_state');

                    // Clear old keys for backwards compatibility
                    localStorage.removeItem('makedo_logged_in');
                    localStorage.removeItem('makedo_email');
                    localStorage.removeItem('makedo_user_id');
                    localStorage.removeItem('makedo_password');

                    console.log('LocalStorage cleared');
                    console.log('Updated makedoState:', makedoState);

                    // Close modal
                    if (modal) modal.classList.add('hidden');
                    console.log('Modal closed');

                    // Update status
                    updateVideoConnectionStatus();
                    console.log('Video connection status updated');
                });
            } else {
                console.error('Disconnect confirm button NOT found!');
            }
            
            // Close modal when clicking outside
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            }
        }
        
        // Handle disconnect video account
        function handleDisconnectVideoAccount() {
            console.log('=== handleDisconnectVideoAccount() called ===');
            // Show confirmation modal
            const modal = document.getElementById('disconnect-video-modal');
            if (modal) {
                modal.classList.remove('hidden');
            } else {
                console.error('Disconnect modal not found!');
            }
        }
        
        // Make functions globally available for onclick handlers
        window.handleSignOut = handleSignOut;
        window.handleDisconnectVideoAccount = handleDisconnectVideoAccount;
        window.applyCrop = applyCrop;
        window.closeCropModal = closeCropModal;
        window.removeLanguage = removeLanguage;
        window.addLanguageRow = addLanguageRow;
        window.updateLanguage = updateLanguage;
        window.removeInterest = removeInterest;
        window.toggleFavorite = toggleFavorite;
        
        // Handle start call
        // Global function for Connect Video Account button
        async function handleConnectVideoAccount() {
            console.log('=== CONNECT VIDEO ACCOUNT CLICKED (via onclick) ===');
            try {
                const result = await showMakedoLoginModal();
                if (result.success) {
                    updateVideoConnectionStatus();
                }
            } catch (error) {
                console.error('Error in handleConnectVideoAccount:', error);
                alert('Error connecting video account: ' + error.message);
            }
        }
        
        // Make it globally available
        window.handleConnectVideoAccount = handleConnectVideoAccount;
        
        // Debug: Log when this runs
        console.log('handleConnectVideoAccount assigned to window:', typeof window.handleConnectVideoAccount);
        
        function handleStartCall() {
            console.log('=== Starting video chat from dashboard ===');

            // Skip profile check for test accounts
            const isTestAccount = userEmail && userEmail.includes('@tabbimate.test');

            // Check if user has languages set (use the actual userLanguages array)
            if (!isTestAccount && (!userLanguages || userLanguages.length === 0)) {
                showProfileIncompleteModal('Add at least one language to start chatting.');
                return;
            }

            console.log('User has profile with languages, redirecting to app...');
            console.log('User languages:', userLanguages);

            // Save current profile to localStorage before navigating
            saveProfileDataSync();

            // Redirect to app.html where they can select language and start matching
            window.location.href = 'app.html';
        }
        
        // Make globally available
        window.handleStartCall = handleStartCall;

        // Handle View Study Notes
        async function handleViewStudyNotes() {
            // Check if user has any session history
            // TODO: Replace with actual session history check from Firestore
            const hasSessionHistory = true; // Set to true to show Study Notes Hub (change to actual check later)

            if (!hasSessionHistory) {
                // Show the "no notes yet" modal
                const modal = document.getElementById('no-notes-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                }
            } else {
                // Navigate to study notes page
                window.location.href = 'study-notes.html';
            }
        }

        window.handleViewStudyNotes = handleViewStudyNotes;
        
        // Save profile data synchronously (for navigation)
        function saveProfileDataSync() {
            if (!userId) return;

            const profileKey = `videotest_profile_${userId}`;
            const profile = {
                name: document.getElementById('name')?.value || '',
                location: document.getElementById('location')?.value || '',
                bio: document.getElementById('bio')?.value || '',
                photoUrl: document.getElementById('profile-preview')?.src || null,
                interests: interests,
                languages: userLanguages
            };

            localStorage.setItem(profileKey, JSON.stringify(profile));

            // Also save current user data for app.html to detect signed-in users
            const currentUser = {
                isSignedInUser: true,
                userId: userId,
                email: userEmail,
                languages: userLanguages,
                interests: interests,
                profile: profile
            };
            localStorage.setItem('videotest_current_user', JSON.stringify(currentUser));

            console.log('Profile data saved before navigation');
        }
        
        // Handle start call
        // Toggle favorite partner
        function toggleFavorite(partnerId, button) {
            const favoriteItem = button.closest('.favorite-item');
            const isActive = button.classList.contains('active');
            
            if (isActive) {
                // Unfavorite: remove the item with animation
                button.classList.remove('active');
                favoriteItem.style.opacity = '0';
                favoriteItem.style.transform = 'translateX(20px)';
                
                setTimeout(() => {
                    favoriteItem.remove();
                    
                    // Check if favorites list is empty
                    const favoritesList = document.querySelector('.favorites-list');
                    if (favoritesList.children.length === 0) {
                        favoritesList.innerHTML = '<div class="empty-state"><p>No favorite partners yet</p></div>';
                    }
                }, 300);
                
                // Save to localStorage (remove from favorites)
                removeFavoriteFromStorage(partnerId);
            } else {
                // Favorite: mark as active
                button.classList.add('active');
                button.setAttribute('aria-label', 'Remove from favorites');
                
                // Save to localStorage (add to favorites)
                addFavoriteToStorage(partnerId);
            }
        }
        
        // Helper functions for localStorage
        function getFavorites() {
            const favorites = localStorage.getItem('videotest_favorites');
            return favorites ? JSON.parse(favorites) : [];
        }
        
        function addFavoriteToStorage(partnerId) {
            const favorites = getFavorites();
            if (!favorites.includes(partnerId)) {
                favorites.push(partnerId);
                localStorage.setItem('videotest_favorites', JSON.stringify(favorites));
            }
        }
        
        function removeFavoriteFromStorage(partnerId) {
            let favorites = getFavorites();
            favorites = favorites.filter(id => id !== partnerId);
            localStorage.setItem('tabbimate_favorites', JSON.stringify(favorites));
        }
        
        // Makedo/VibeChat state
        const makedoState = {
            isLoggedIn: false,
            userEmail: null,
            userId: null
        };
        
        // Update video connection status display
        function updateVideoConnectionStatus() {
            loadMakedoLoginState();
            
            const statusBadge = document.getElementById('video-status-badge');
            const statusText = document.getElementById('video-status-text');
            const statusDescription = document.getElementById('video-status-description');
            const accountDetails = document.getElementById('video-account-details');
            const connectBtn = document.getElementById('connect-video-account-btn');
            const disconnectBtn = document.getElementById('disconnect-video-account-btn');
            const emailDisplay = document.getElementById('video-account-email');
            
            if (makedoState.isLoggedIn) {
                // Connected state
                statusBadge.classList.remove('status-disconnected');
                statusBadge.classList.add('status-connected');
                statusText.textContent = 'Connected';
                statusDescription.textContent = 'Your video account is connected and ready for video chats.';
                
                accountDetails.classList.remove('hidden');
                emailDisplay.textContent = makedoState.userEmail;
                
                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
            } else {
                // Disconnected state
                statusBadge.classList.remove('status-connected');
                statusBadge.classList.add('status-disconnected');
                statusText.textContent = 'Not Connected';
                statusDescription.textContent = 'Connect your video account to enable real-time video chat with language partners.';
                
                accountDetails.classList.add('hidden');
                
                connectBtn.classList.remove('hidden');
                disconnectBtn.classList.add('hidden');
            }
        }
        
        // Show Makedo login modal
        function showMakedoLoginModal() {
            console.log('=== showMakedoLoginModal() called ===');
            return new Promise((resolve, reject) => {
                const modal = document.getElementById('makedo-login-modal');
                const emailInput = document.getElementById('makedo-email');
                const passwordInput = document.getElementById('makedo-password');
                const errorDiv = document.getElementById('makedo-login-error');
                const submitBtn = document.getElementById('makedo-login-submit');
                const cancelBtn = document.getElementById('makedo-cancel');
                const loginText = document.getElementById('makedo-login-text');
                const loginSpinner = document.getElementById('makedo-login-spinner');
                
                console.log('Modal elements found:');
                console.log('- modal:', !!modal);
                console.log('- submitBtn:', !!submitBtn);
                console.log('- cancelBtn:', !!cancelBtn);
                console.log('- emailInput:', !!emailInput);
                console.log('- passwordInput:', !!passwordInput);
                
                // Show modal
                console.log('Showing modal...');
                modal.classList.remove('hidden');
                errorDiv.classList.add('hidden');
                
                // Pre-fill email if available
                if (userEmail) {
                    emailInput.value = userEmail;
                }
                
                // Handle submit
                const handleSubmit = async (e) => {
                    console.log('=== CONNECT BUTTON CLICKED ===');
                    if (e) e.preventDefault();
                    
                    const email = emailInput.value.trim().toLowerCase();
                    const password = passwordInput.value;
                    
                    console.log('Email:', email);
                    console.log('Password length:', password.length);
                    
                    if (!email || !password) {
                        console.error('Validation failed: missing email or password');
                        errorDiv.textContent = 'Please enter both email and password';
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    
                    console.log('Validation passed, showing loading state...');
                    
                    // Show loading state
                    loginText.textContent = 'Connecting...';
                    loginSpinner.classList.remove('hidden');
                    submitBtn.disabled = true;
                    errorDiv.classList.add('hidden');
                    
                    console.log('Starting Makedo login with Fetch.login()...');
                    console.log('Email:', email);
                    
                    try {
                        // Check if Fetch is available
                        if (typeof Fetch === 'undefined') {
                            throw new Error('Fetch module not loaded. Please refresh the page and try again.');
                        }
                        
                        // Use Fetch.login() from fetch.js (imported at top of module)
                        const result = await Fetch.login({ email, password });
                        
                        console.log('Login result:', result);
                        console.log('Result status:', result.status);
                        console.log('Full result object:', JSON.stringify(result));
                        
                        if (result.status === 'loggedIn') {
                            // Success!
                            makedoState.isLoggedIn = true;
                            makedoState.userEmail = result.email || email;
                            makedoState.userId = result.pid;
                            
                            console.log('Makedo login successful:', makedoState);
                            
                            // Note: We don't initialize VibeChat here on the dashboard
                            // VibeChat will be initialized later on app.html when video chat is needed
                            
                            // Save login state to localStorage (including password for re-login)
                            saveMakedoLoginState(password);
                            
                            // Update UI to show connected status
                            updateVideoConnectionStatus();
                            
                            // Hide modal
                            modal.classList.add('hidden');
                            
                            // Clean up
                            cleanup();
                            
                            // Resolve promise
                            resolve({ success: true, data: makedoState });
                        } else {
                            console.error('Login failed. Result:', result);
                            throw new Error(result.message || result.error || 'Login failed. Please check your credentials.');
                        }
                        
                    } catch (error) {
                        console.error('=== MAKEDO LOGIN ERROR ===');
                        console.error('Error type:', error.constructor.name);
                        console.error('Error message:', error.message);
                        console.error('Error stack:', error.stack);
                        console.error('Full error:', error);
                        
                        errorDiv.textContent = error.message || 'Connection failed. Please try again.';
                        errorDiv.classList.remove('hidden');
                        
                        // Reset button
                        loginText.textContent = 'Connect';
                        loginSpinner.classList.add('hidden');
                        submitBtn.disabled = false;
                    }
                };
                
                console.log('=== Makedo Login Modal Setup Complete ===');
                console.log('Submit button:', submitBtn);
                console.log('Cancel button:', cancelBtn);
                
                // Handle cancel
                const handleCancel = () => {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve({ success: false, cancelled: true });
                };
                
                // Cleanup function
                const cleanup = () => {
                    submitBtn.removeEventListener('click', handleSubmit);
                    cancelBtn.removeEventListener('click', handleCancel);
                    passwordInput.removeEventListener('keypress', handleKeyPress);
                    emailInput.value = '';
                    passwordInput.value = '';
                    loginText.textContent = 'Connect';
                    loginSpinner.classList.add('hidden');
                    submitBtn.disabled = false;
                };
                
                // Handle Enter key
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter') handleSubmit(e);
                };
                
                // Attach listeners
                console.log('Attaching event listeners to modal buttons...');
                submitBtn.addEventListener('click', handleSubmit);
                cancelBtn.addEventListener('click', handleCancel);
                passwordInput.addEventListener('keypress', handleKeyPress);
                console.log('Event listeners attached successfully');
                console.log('Modal is now interactive');
            });
        }
        
        // Save Makedo login state to localStorage
        function saveMakedoLoginState(password) {
            console.log('saveMakedoLoginState called with password:', password ? '***' : 'undefined');
            console.log('makedoState.isLoggedIn:', makedoState.isLoggedIn);
            console.log('makedoState.userEmail:', makedoState.userEmail);

            if (makedoState.isLoggedIn) {
                const stateToSave = {
                    isLoggedIn: true,
                    userEmail: makedoState.userEmail,
                    userId: makedoState.userId,
                    password: password  // Store for video session re-login
                };
                localStorage.setItem('videotest_makedo_state', JSON.stringify(stateToSave));
                console.log('âœ… Makedo login state saved to localStorage');
                console.log('Saved state:', stateToSave);
            } else {
                console.log('âŒ Not saving - makedoState.isLoggedIn is false');
            }
        }
        
        // Load Makedo login state from localStorage
        function loadMakedoLoginState() {
            const stateStr = localStorage.getItem('videotest_makedo_state');
            if (stateStr) {
                try {
                    const state = JSON.parse(stateStr);
                    makedoState.isLoggedIn = state.isLoggedIn || false;
                    makedoState.userEmail = state.userEmail || null;
                    makedoState.userId = state.userId || null;
                    console.log('Loaded Makedo login state:', makedoState);
                } catch (e) {
                    console.error('Error loading Makedo state:', e);
                }
            }
            /* Old code:
            const isLoggedIn = localStorage.getItem('makedo_logged_in') === 'true';
            if (isLoggedIn) {
                makedoState.isLoggedIn = true;
                makedoState.userEmail = localStorage.getItem('makedo_email');
                makedoState.userId = localStorage.getItem('makedo_user_id');
                
                console.log('Loaded Makedo login state:', makedoState);
                
                // Re-initialize VibeChat with saved credentials (done async after page load)
                setTimeout(() => {
                    if (window.vibeChat && window.vibeChat.onLoginSuccess) {
                        window.vibeChat.onLoginSuccess({
                            email: makedoState.userEmail,
                            userId: makedoState.userId
                        }).catch(err => {
                            console.warn('Failed to restore Makedo session:', err);
                            // Clear invalid session
                            localStorage.removeItem('makedo_logged_in');
                            makedoState.isLoggedIn = false;
                        });
                    }
                }, 1000);
            }
            */
        }
        
        // Get Makedo account for current Firebase user
        // Each user logs into Makedo with their OWN account (same email as Firebase)
        function getPairedMakedoAccount(firebaseEmail) {
            // All test accounts use the same password
            const pairings = {
                'test01@tabbimate.test': { email: 'test01@tabbimate.test', password: 'test123456' },
                'test10@tabbimate.test': { email: 'test10@tabbimate.test', password: 'test123456' },
                'test02@tabbimate.test': { email: 'test02@tabbimate.test', password: 'test123456' },
                'test03@tabbimate.test': { email: 'test03@tabbimate.test', password: 'test123456' },
                'test04@tabbimate.test': { email: 'test04@tabbimate.test', password: 'test123456' },
                'test05@tabbimate.test': { email: 'test05@tabbimate.test', password: 'test123456' },
                'test06@tabbimate.test': { email: 'test06@tabbimate.test', password: 'test123456' },
                'test07@tabbimate.test': { email: 'test07@tabbimate.test', password: 'test123456' },
                'test08@tabbimate.test': { email: 'test08@tabbimate.test', password: 'test123456' },
                'test09@tabbimate.test': { email: 'test09@tabbimate.test', password: 'test123456' },
                'test11@tabbimate.test': { email: 'test11@tabbimate.test', password: 'test123456' },
                'test12@tabbimate.test': { email: 'test12@tabbimate.test', password: 'test123456' },
                'test13@tabbimate.test': { email: 'test13@tabbimate.test', password: 'test123456' },
                'test14@tabbimate.test': { email: 'test14@tabbimate.test', password: 'test123456' },
                'test15@tabbimate.test': { email: 'test15@tabbimate.test', password: 'test123456' },
                'test16@tabbimate.test': { email: 'test16@tabbimate.test', password: 'test123456' },
                'test17@tabbimate.test': { email: 'test17@tabbimate.test', password: 'test123456' },
                'test18@tabbimate.test': { email: 'test18@tabbimate.test', password: 'test123456' },
                'test19@tabbimate.test': { email: 'test19@tabbimate.test', password: 'test123456' },
                'test20@tabbimate.test': { email: 'test20@tabbimate.test', password: 'test123456' }
            };

            return pairings[firebaseEmail.toLowerCase()] || null;
        }

        // Auto-connect to paired Makedo account
        async function attemptAutoConnectMakedo() {
            console.log('ðŸ”„ Attempting auto-connect to Makedo...');

            // Get user email from Firebase
            if (!userEmail) {
                console.log('âŒ No user email available for auto-connect');
                return;
            }

            console.log(`ðŸ“§ Current Firebase user: ${userEmail}`);

            // Get the expected Makedo account for this Firebase user
            const expectedMakedoAccount = getPairedMakedoAccount(userEmail);
            if (!expectedMakedoAccount) {
                console.log('âŒ No paired Makedo account found for this user');
                return;
            }

            console.log(`ðŸ”— Expected Makedo account: ${expectedMakedoAccount.email}`);

            // Check if already connected
            loadMakedoLoginState();
            if (makedoState.isLoggedIn && makedoState.userEmail) {
                console.log(`ðŸ“‹ Found existing Makedo session: ${makedoState.userEmail}`);

                // Validate that the logged-in Makedo account matches the expected one
                if (makedoState.userEmail.toLowerCase() === expectedMakedoAccount.email.toLowerCase()) {
                    console.log('âœ… Makedo account matches Firebase account - keeping session');
                    updateVideoConnectionStatus();
                    return;
                } else {
                    console.log('âš ï¸ MISMATCH DETECTED!');
                    console.log(`   Firebase: ${userEmail}`);
                    console.log(`   Expected Makedo: ${expectedMakedoAccount.email}`);
                    console.log(`   Current Makedo: ${makedoState.userEmail}`);
                    console.log('ðŸ”„ Clearing mismatched Makedo session and logging in with correct account...');

                    // Clear the mismatched session
                    localStorage.removeItem('videotest_makedo_state');
                    makedoState.isLoggedIn = false;
                    makedoState.userEmail = null;
                    makedoState.userId = null;
                }
            }

            // Proceed with login using the correct account
            console.log('âœ… Attempting auto-login to Makedo account...');

            try {
                // Check if Fetch is available
                if (typeof Fetch === 'undefined') {
                    console.error('âŒ Fetch module not loaded');
                    return;
                }

                // Use Fetch.login() with object parameter (same as manual login)
                console.log('Calling Fetch.login() with email:', expectedMakedoAccount.email);
                const result = await Fetch.login({
                    email: expectedMakedoAccount.email,
                    password: expectedMakedoAccount.password
                });

                console.log('Login result:', result);
                console.log('Result status:', result?.status);

                if (result && result.status === 'loggedIn') {
                    console.log('ðŸŽ‰ Auto-connected to Makedo successfully!');
                    makedoState.isLoggedIn = true;
                    makedoState.userEmail = result.email || expectedMakedoAccount.email;
                    makedoState.userId = result.pid;

                    saveMakedoLoginState(expectedMakedoAccount.password);
                    updateVideoConnectionStatus();
                } else {
                    console.log('âŒ Auto-connect failed. Result:', result);
                }
            } catch (error) {
                console.error('âŒ Auto-connect error:', error);
            }
        }

        // Setup video connection button listeners
        function setupVideoConnectionButtons() {
            console.log('=== setupVideoConnectionButtons() called ===');
            const connectBtn = document.getElementById('connect-video-account-btn');
            const disconnectBtn = document.getElementById('disconnect-video-account-btn');
            
            console.log('Connect button found:', !!connectBtn);
            console.log('Disconnect button found:', !!disconnectBtn);
            
            if (connectBtn) {
                console.log('Attaching click listener to Connect Video Account button');
                connectBtn.addEventListener('click', async () => {
                    console.log('=== CONNECT VIDEO ACCOUNT BUTTON CLICKED ===');
                    const result = await showMakedoLoginModal();
                    if (result.success) {
                        updateVideoConnectionStatus();
                    }
                });
                console.log('Connect button listener attached');
            } else {
                console.error('Connect button NOT found!');
            }
            
            if (disconnectBtn) {
                console.log('Attaching click listener to Disconnect button');
                disconnectBtn.addEventListener('click', () => {
                    console.log('=== DISCONNECT VIDEO ACCOUNT BUTTON CLICKED ===');
                    
                    // Show confirmation modal
                    const modal = document.getElementById('disconnect-video-modal');
                    if (modal) {
                        modal.classList.remove('hidden');
                    }
                });
                console.log('Disconnect button listener attached');
            } else {
                console.error('Disconnect button NOT found!');
            }
            
            // Update status on page load
            updateVideoConnectionStatus();
        }
        
        // Initialize when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                init();
                setupVideoConnectionButtons();
                setupSignOutModal();
                setupProfileIncompleteModal();
                setupCropModal();
                setupDisconnectVideoModal();
                setupNoNotesModal();
            });
        } else {
            init();
            setupVideoConnectionButtons();
            setupSignOutModal();
            setupProfileIncompleteModal();
            setupCropModal();
            setupDisconnectVideoModal();
            setupNoNotesModal();
        }
    </script>
    
    <!-- Photo Crop Modal -->
    <div id="crop-modal" class="crop-modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div class="crop-modal-content" style="background: white; border-radius: 16px; width: 90%; max-width: 700px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); overflow: hidden;">
            <div class="crop-header" style="padding: 24px 32px; background: #BF3143; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: white; font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    Crop Your Photo
                </h3>
                <button id="crop-close-x-btn" class="crop-close-btn" style="background: rgba(255,255,255,0.2); border: none; width: 36px; height: 36px; border-radius: 8px; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; line-height: 1;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    Ã—
                </button>
            </div>
            <div class="crop-container" style="padding: 32px;">
                <div class="crop-area" style="position: relative; width: 100%; max-height: 600px; background: #F3F4F6; border-radius: 12px; overflow: auto; display: flex; align-items: center; justify-content: center;">
                    <img id="crop-image" src="" alt="Image to crop" style="max-width: 100%; height: auto; display: block; user-select: none;">
                    <div class="crop-box" id="crop-box" style="position: absolute; border: 2px solid #BF3143; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); cursor: move;">
                        <div class="crop-handle nw" style="position: absolute; width: 12px; height: 12px; background: white; border: 2px solid #BF3143; border-radius: 50%; top: -6px; left: -6px; cursor: nw-resize;"></div>
                        <div class="crop-handle ne" style="position: absolute; width: 12px; height: 12px; background: white; border: 2px solid #BF3143; border-radius: 50%; top: -6px; right: -6px; cursor: ne-resize;"></div>
                        <div class="crop-handle sw" style="position: absolute; width: 12px; height: 12px; background: white; border: 2px solid #BF3143; border-radius: 50%; bottom: -6px; left: -6px; cursor: sw-resize;"></div>
                        <div class="crop-handle se" style="position: absolute; width: 12px; height: 12px; background: white; border: 2px solid #BF3143; border-radius: 50%; bottom: -6px; right: -6px; cursor: se-resize;"></div>
                    </div>
                </div>
                <p style="margin-top: 16px; text-align: center; color: #6B7280; font-size: 14px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; vertical-align: text-bottom; margin-right: 4px;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    Drag the box to adjust your crop area, or resize using the corner handles
                </p>
            </div>
            <div class="crop-actions" style="padding: 0 32px 32px; display: flex; gap: 12px;">
                <button id="crop-cancel-btn" class="btn btn-secondary crop-cancel-button" style="flex: 1; background: #F3F4F6; color: #374151; border: none; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">
                    Cancel
                </button>
                <button id="crop-apply-btn" class="btn btn-primary crop-apply-button" style="flex: 1; background: #BF3143; color: white; border: none; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(191, 49, 67, 0.3); transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">
                    Apply Crop
                </button>
            </div>
        </div>
    </div>
    
    <!-- Makedo Video Login Modal -->
    <div class="modal-overlay hidden" id="makedo-login-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div class="modal-dialog" style="background: white; border-radius: 12px; max-width: 420px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
            <div class="modal-header" style="padding: 24px 24px 16px; border-bottom: 1px solid #E5E7EB;">
                <h3 class="modal-title" style="font-size: 18px; font-weight: 600; color: #111827; margin: 0;">Connect Video Account</h3>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <p style="margin-bottom: 20px; color: #6B7280; font-size: 14px;">
                    Sign in to enable real-time video chat with language partners.
                </p>
                
                <form id="makedo-login-form">
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label for="makedo-email" style="display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; color: #374151;">Email</label>
                        <input 
                            type="email" 
                            id="makedo-email" 
                            class="modal-input" 
                            placeholder="your@email.com" 
                            required
                            style="width: 100%; padding: 10px 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 14px; font-family: inherit;"
                        >
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label for="makedo-password" style="display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; color: #374151;">Password</label>
                        <input 
                            type="password" 
                            id="makedo-password" 
                            class="modal-input" 
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" 
                            required
                            style="width: 100%; padding: 10px 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 14px; font-family: inherit;"
                        >
                    </div>
                    
                    <div id="makedo-login-error" class="hidden" style="padding: 10px 12px; background: #FEE2E2; border: 1px solid #FECACA; border-radius: 8px; color: #DC2626; font-size: 13px; margin-bottom: 16px;">
                        Login failed. Please check your credentials.
                    </div>
                    
                    <div style="font-size: 12px; color: #9CA3AF; margin-bottom: 16px;">
                        Don't have a video account? <a href="https://proto2.makedo.com:8883/signup" target="_blank" style="color: #BF3143; text-decoration: none;">Sign up here</a>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #E5E7EB; display: flex; justify-content: flex-end; gap: 12px;">
                <button class="btn btn-secondary" id="makedo-cancel" style="background: #F3F4F6; color: #374151;">Cancel</button>
                <button class="btn btn-primary" id="makedo-login-submit">
                    <span id="makedo-login-text">Connect</span>
                    <span id="makedo-login-spinner" class="hidden" style="margin-left: 8px;">â³</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Sign Out Confirmation Modal -->
    <div class="modal-overlay hidden" id="signout-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div class="modal-dialog" style="background: white; border-radius: 16px; max-width: 420px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); overflow: hidden;">
            <div class="modal-header" style="padding: 32px 32px 24px; background: #BF3143; text-align: center;">
                <div style="width: 64px; height: 64px; background: white; border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#BF3143" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </div>
                <h3 class="modal-title" style="font-size: 22px; font-weight: 700; color: white; margin: 0;">Sign Out</h3>
            </div>
            <div class="modal-body" style="padding: 32px;">
                <p style="margin: 0; color: #4B5563; font-size: 16px; text-align: center; line-height: 1.6;">
                    Are you sure you want to sign out?<br>
                    <span style="font-size: 14px; color: #9CA3AF;">You can always sign back in anytime.</span>
                </p>
            </div>
            <div class="modal-footer" style="padding: 0 32px 32px; display: flex; gap: 12px;">
                <button class="btn btn-secondary signout-cancel-btn" id="signout-cancel" style="flex: 1; background: #F3F4F6; color: #374151; border: none; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">
                    Cancel
                </button>
                <button class="btn btn-primary signout-confirm-btn" id="signout-confirm" style="flex: 1; background: #BF3143; color: white; border: none; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(191, 49, 67, 0.3); transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">
                    Sign Out
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Completion Required Modal -->
    <div class="modal-overlay hidden" id="profile-incomplete-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div class="modal-dialog" style="background: white; border-radius: 16px; max-width: 420px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); overflow: hidden;">
            <div class="modal-header" style="padding: 32px 32px 24px; background: #BF3143; text-align: center;">
                <div style="width: 64px; height: 64px; background: white; border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#BF3143" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <h3 class="modal-title" style="font-size: 22px; font-weight: 700; color: white; margin: 0;">Complete Your Profile</h3>
            </div>
            <div class="modal-body" style="padding: 32px;">
                <p id="profile-incomplete-message" style="margin: 0; color: #4B5563; font-size: 16px; text-align: center; line-height: 1.6;">
                    Add your languages and interests to start chatting.
                </p>
            </div>
            <div class="modal-footer" style="padding: 0 32px 32px; display: flex; gap: 12px;">
                <button class="btn btn-primary" id="profile-incomplete-ok" style="flex: 1; background: #BF3143; color: white; border: none; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(191, 49, 67, 0.3); transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">
                    Got It
                </button>
            </div>
        </div>
    </div>

    <!-- Disconnect Video Account Modal -->
    <div class="modal-overlay hidden" id="disconnect-video-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div class="modal-dialog" style="background: white; border-radius: 16px; max-width: 420px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); overflow: hidden;">
            <div class="modal-header" style="padding: 32px 32px 24px; background: #BF3143; text-align: center;">
                <div style="width: 64px; height: 64px; background: white; border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#BF3143" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 7l-7 5 7 5V7z"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                        <line x1="1" y1="1" x2="23" y2="23"/>
                    </svg>
                </div>
                <h3 class="modal-title" style="font-size: 22px; font-weight: 700; color: white; margin: 0;">Disconnect Video Account</h3>
            </div>
            <div class="modal-body" style="padding: 32px;">
                <p style="margin: 0; color: #4B5563; font-size: 16px; text-align: center; line-height: 1.6;">
                    Are you sure you want to disconnect your video account?<br>
                    <span style="font-size: 14px; color: #9CA3AF;">You won't be able to start video chats until you reconnect.</span>
                </p>
            </div>
            <div class="modal-footer" style="padding: 0 32px 32px; display: flex; gap: 12px;">
                <button class="btn btn-secondary disconnect-cancel-btn" id="disconnect-cancel" style="flex: 1; background: #F3F4F6; color: #374151; border: none; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">
                    Cancel
                </button>
                <button class="btn btn-primary disconnect-confirm-btn" id="disconnect-confirm" style="flex: 1; background: #BF3143; color: white; border: none; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(191, 49, 67, 0.3); transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">
                    Disconnect
                </button>
            </div>
        </div>
    </div>

    <!-- No Study Notes Modal -->
    <div class="modal-overlay hidden" id="no-notes-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div class="modal-content" style="background: white; border-radius: 16px; max-width: 420px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 48px 40px;">
            <div style="text-align: center; margin-bottom: 40px;">
                <div style="width: 48px; height: 48px; margin: 0 auto 24px; display: flex; align-items: center; justify-content: center;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                </div>
                <h2 style="font-size: 22px; font-weight: 600; color: #111827; margin: 0 0 12px; line-height: 1.3;">Your study notes will appear here</h2>
                <p style="font-size: 15px; color: #6B7280; margin: 0; line-height: 1.5;">Start your first conversation to create your notes.</p>
            </div>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn btn-secondary" id="no-notes-close" style="background: #F3F4F6; color: #374151; border: none; padding: 12px 24px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                    Not now
                </button>
                <button class="btn btn-primary" id="no-notes-start-session" style="background: #BF3143; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                    Start session
                </button>
            </div>
        </div>
    </div>

    <!-- VibeChat Module -->
    <script type="module">
        import VibeChat from './vibechat1_ux.js';
        window.VibeChat = VibeChat;
        window.vibeChat = null;
        console.log('VibeChat module loaded on dashboard');
    </script>
</body>
</html>

